// prisma/schema.prisma (최종 수정 버전)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Provider {
  EMAIL
  KAKAO
  GOOGLE
}

/// -----------------------------------------------------------
/// 1. 사용자 관련 엔티티
/// -----------------------------------------------------------

model User {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  email                String    @unique
  password             String
  nickname             String    @unique
  profileImageUrl      String?
  provider             String? // 'EMAIL', 'GOOGLE', 'KAKAO'
  providerId           String? // 소셜 로그인 제공자의 고유 ID
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // 소속된 커플 정보
  coupleId             String?   @db.ObjectId
  couple               Couple?   @relation(fields: [coupleId], references: [id])
  
  // 파트너 연결 (수정)
  partnerId            String?   
  partner              User?     @relation("UserPartner", fields: [partnerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  partnerOf            User[]    @relation("UserPartner")

  // 작성한 데이터
  sentMessages         Message[] @relation("SentMessages")
  receivedMessages     Message[] @relation("ReceivedMessages")
  sentEmotionCards     EmotionCard[] @relation("SentEmotionCards")
  receivedEmotionCards EmotionCard[] @relation("ReceivedEmotionCards")
  posts                CommunityPost[]
  comments             Comment[]
  emotionJournals      EmotionJournal[]
  votes                CommunityPostVote[]
  surveys              RelationshipSurvey[]
  reportsAsReporter    Report[] @relation("ReportsByReporter")
  reportsAsReported    Report[] @relation("ReportsOnReported")
  diaries              Diary[] // 감정일기 1:N 관계 추가

  // 파트너 초대 관련 관계 추가
  sentInvites     PartnerInvite[] @relation("SentInvites")
  receivedInvites PartnerInvite[] @relation("ReceivedInvites")
}

model Couple {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  status         CoupleStatus @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  members        User[]
  challenges     Challenge[]
  reports        Report[]
  emotionCards   EmotionCard[]
  partnerInvites PartnerInvite[] // 파트너 초대 정보와 1:N 관계
}

model PartnerInvite {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  code        String         @unique // 초대 코드
  status      InviteStatus   @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  inviterId   String         @db.ObjectId
  inviter     User           @relation("SentInvites", fields: [inviterId], references: [id])
  
  inviteeId   String?        @db.ObjectId // 초대 코드 입력 시점에 설정
  invitee     User?          @relation("ReceivedInvites", fields: [inviteeId], references: [id])
  
  coupleId    String?        @db.ObjectId // 초대 수락 시점에 생성된 커플 ID
  couple      Couple?        @relation(fields: [coupleId], references: [id])

  @@index([inviterId])
  @@index([inviteeId])
}

enum CoupleStatus {
  PENDING
  ACTIVE
  INACTIVE
}

enum InviteStatus {
  PENDING    // 초대 코드 생성됨
  RESPONDED  // 초대 코드 입력됨
  CONFIRMED  // 초대 수락됨
  REJECTED   // 초대 거절됨
  EXPIRED    // 초대 만료됨
}

/// -----------------------------------------------------------
/// 2. 공유 기능 관련 엔티티
/// -----------------------------------------------------------

model Challenge {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  title                String
  description          String
  recommendationDate   DateTime
  isCompletedByMember1 Boolean  @default(false)
  isCompletedByMember2 Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  coupleId             String   @db.ObjectId
  couple               Couple   @relation(fields: [coupleId], references: [id])
}

model EmotionCard {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  message      String
  aiSuggestion String?
  isRead       Boolean  @default(false)
  emoji        String?
  createdAt    DateTime @default(now())

  senderId     String   @db.ObjectId
  sender       User     @relation("SentEmotionCards", fields: [senderId], references: [id])

  receiverId   String   @db.ObjectId
  receiver     User     @relation("ReceivedEmotionCards", fields: [receiverId], references: [id])

  coupleId     String   @db.ObjectId
  couple       Couple   @relation(fields: [coupleId], references: [id])
}

model RelationshipSurvey {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  score        Int
  surveyDate   DateTime @default(now())
  createdAt    DateTime @default(now())

  respondentId String   @db.ObjectId
  respondent   User     @relation(fields: [respondentId], references: [id])
}

model Report {
  id                       String   @id @default(auto()) @map("_id") @db.ObjectId
  weekStartDate            DateTime
  overallScore             Int
  cardsSentCount           Int
  challengesCompletedCount Int
  reason                   String
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  coupleId                 String   @db.ObjectId
  couple                   Couple   @relation(fields: [coupleId], references: [id])
  
  reporterId               String   @db.ObjectId
  reporter                 User     @relation("ReportsByReporter", fields: [reporterId], references: [id])

  reportedId               String   @db.ObjectId
  reported                 User     @relation("ReportsOnReported", fields: [reportedId], references: [id])
}

model Message {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  senderId   String   @db.ObjectId
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])

  receiverId String   @db.ObjectId
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

/// -----------------------------------------------------------
/// 3. 개인 및 커뮤니티 기능 관련 엔티티
/// -----------------------------------------------------------

model Category {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  name           String          @unique
  isPollCategory Boolean         @default(false)
  posts          CommunityPost[]
}

model Content {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  body      String
  type      ContentType @default(ARTICLE)
  isPremium Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum ContentType {
  ARTICLE
  VIDEO
  AUDIO
  PREMIUM
}

model EmotionJournal {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String?
  content     String
  isAnonymous Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  authorId    String    @db.ObjectId
  author      User      @relation(fields: [authorId], references: [id])
  comments    Comment[]
}

model CommunityPost {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  content    String
  imageUrl   String?
  viewCount  Int       @default(0)
  tags       String[]
  poll       Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  authorId   String    @db.ObjectId
  author     User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId String    @db.ObjectId
  category   Category  @relation(fields: [categoryId], references: [id])
  comments   Comment[]
  votes      CommunityPostVote[]
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId  String   @db.ObjectId
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  communityPostId    String?  @db.ObjectId
  communityPost      CommunityPost? @relation(fields: [communityPostId], references: [id], onDelete: Cascade)
  
  journalId String?  @db.ObjectId
  journal   EmotionJournal? @relation(fields: [journalId], references: [id])

  parentId  String?  @db.ObjectId
  parent    Comment? @relation("CommentToParent", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Comment[] @relation("CommentToParent")
}

model CommunityPostVote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  option    String
  createdAt DateTime @default(now())

  postId    String   @db.ObjectId
  post      CommunityPost @relation(fields: [postId], references: [id])
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

model Diary {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  date        String
  emotion     Json
  triggers    Json
  comment     String
  palette     Json
  randomInfo  Json
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}